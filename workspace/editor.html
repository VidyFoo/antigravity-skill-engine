<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>PPT Live Editor - 演示文稿实时编辑器</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/inter-ui/inter.css">
    <style>
        :root {
            --bg: #1e1e1e;
            --sidebar: #252526;
            --accent: #E33737;
            --text: #d4d4d4;
        }

        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100%;
        }

        /* 侧边栏 */
        .sidebar {
            width: 220pt;
            background: var(--sidebar);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15pt;
            border-bottom: 1px solid #333;
            font-weight: 800;
            color: #FFF;
            font-size: 14pt;
        }

        .slide-list {
            flex: 1;
            overflow-y: auto;
            padding: 10pt;
        }

        .slide-item {
            padding: 8pt 12pt;
            margin-bottom: 4pt;
            cursor: pointer;
            border-radius: 4pt;
            transition: 0.2s;
            font-size: 10pt;
        }

        .slide-item:hover {
            background: #37373d;
        }

        .slide-item.active {
            background: var(--accent);
            color: #FFF;
        }

        /* 主编辑区 */
        .main-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            height: 40pt;
            background: var(--sidebar);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15pt;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6pt 15pt;
            border-radius: 4pt;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:disabled {
            background: #555;
        }

        .split-view {
            flex: 1;
            display: flex;
            background: #FFF;
        }

        #monaco-container {
            width: 45%;
            height: 100%;
            background: var(--bg);
        }

        .preview-container {
            flex: 1;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* 模拟 16:9 比例预览 */
        #preview-frame {
            width: 720pt;
            height: 405pt;
            background: #FFF;
            border: none;
            box-shadow: 0 10pt 30pt rgba(0, 0, 0, 0.5);
            transform-origin: center;
        }

        .status-bar {
            height: 20pt;
            background: #007acc;
            font-size: 9pt;
            display: flex;
            align-items: center;
            padding: 0 10pt;
            color: white;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">PPT SLIDES</div>
            <div id="slideList" class="slide-list"></div>
        </div>
        <div class="main-editor">
            <div class="toolbar">
                <div id="currentSlideName">Select a slide</div>
                <div>
                    <button class="btn" onclick="generatePPTX()">一键生成 PPTX</button>
                </div>
            </div>
            <div class="split-view">
                <div id="monaco-container"></div>
                <div class="preview-container">
                    <iframe id="preview-frame"></iframe>
                </div>
            </div>
            <div class="status-bar" id="statusText">Ready</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <script>
        let editor;
        let activeSlide = '';

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('monaco-container'), {
                value: '',
                language: 'html',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14
            });

            editor.onDidChangeModelContent(() => {
                const content = editor.getValue();
                updatePreview(content);
                saveSlide(content);
            });

            loadSlideList();
        });

        async function loadSlideList() {
            const res = await fetch('/api/slides');
            const files = await res.json();
            const listEl = document.getElementById('slideList');
            listEl.innerHTML = files.map(f => `<div class="slide-item" onclick="loadSlide('${f}')">${f}</div>`).join('');
            if (files.length > 0) loadSlide(files[0]);
        }

        async function loadSlide(name) {
            activeSlide = name;
            document.querySelectorAll('.slide-item').forEach(el => {
                el.classList.toggle('active', el.innerText === name);
            });
            document.getElementById('currentSlideName').innerText = name;

            const res = await fetch(`/api/slide/${name}`);
            const data = await res.json();
            editor.setValue(data.content);
            updatePreview(data.content);
        }

        function updatePreview(content) {
            const iframe = document.getElementById('preview-frame');
            // 解决相对路径问题，注入 base 标签
            const baseTag = `<base href="${location.origin}/slides/">`;
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const finalContent = content.replace('<head>', '<head>' + baseTag);
            doc.open();
            doc.write(finalContent);
            doc.close();
        }

        let saveTimeout;
        function saveSlide(content) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                document.getElementById('statusText').innerText = 'Saving...';
                await fetch(`/api/slide/${activeSlide}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                document.getElementById('statusText').innerText = 'Saved';
            }, 500);
        }

        async function generatePPTX() {
            const btn = document.querySelector('.btn');
            btn.disabled = true;
            document.getElementById('statusText').innerText = 'Generating PPTX... (Please wait)';
            const res = await fetch('/api/generate', { method: 'POST' });
            const data = await res.json();
            btn.disabled = false;
            if (data.success) {
                alert('PPTX 生成成功！请在 workspace 目录下查看。');
                document.getElementById('statusText').innerText = 'Generation Success';
            } else {
                alert('生成失败: ' + data.error);
                document.getElementById('statusText').innerText = 'Generation Failed';
            }
        }
    </script>
</body>

</html>